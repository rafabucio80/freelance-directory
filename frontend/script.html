<script>
document.addEventListener('DOMContentLoaded', function() {
    google.script.run.withSuccessHandler(showProducts).getProducts();
});

let carrito = [];

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// Función para mostrar el modal con el detalle del producto
function showProductDetail(product) {
    const modal = document.getElementById('productDetailModal');
    const modalContent = document.getElementById('modalProductContent');

    // Limpiar el contenido anterior
    modalContent.innerHTML = '';

    // Crear el contenido del modal con los detalles del producto
    const contentHtml = `
        <h2>${product.title}</h2>
        <img src="${product.image}" alt="${product.title}" style="max-width: 100%;" />
        <p>${product.description}</p>
        <p><strong>Precio:</strong> ${formatPrice(product.price)}</p>
    `;

    // Insertar el contenido en el modal
    modalContent.insertAdjacentHTML('beforeend', contentHtml);

    // Mostrar el modal
    modal.style.display = 'block';
}

// Función para cerrar el modal
function closeModal() {
    const modal = document.getElementById('productDetailModal');
    modal.style.display = 'none';
}

// Cerrar el modal cuando el usuario hace clic fuera del contenido del modal
window.onclick = function(event) {
    const modal = document.getElementById('productDetailModal');
    if (event.target == modal) {
        modal.style.display = 'none';
    }
}

// Actualizar la función showProducts para incluir el event listener en la imagen
function showProducts(products) {
    const container = document.getElementById('productContainer');
    container.innerHTML = ''; // Limpiar el contenedor antes de agregar contenido

    const categories = {};

    // Agrupar productos por categoría
    products.forEach(product => {
        if (!categories[product.category]) {
            categories[product.category] = [];
        }
        categories[product.category].push(product);
    });

    // Crear secciones para cada categoría
    Object.keys(categories).forEach(category => {
        const section = document.createElement('div');
        section.classList.add('category-section', 'mb-5');
        
        const headerHtml = `
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">${category}</h2>
                <a href="#" class="btn btn-link">Ver más</a>
            </div>`;
        section.insertAdjacentHTML('beforeend', headerHtml);

        const productRow = document.createElement('div');
        productRow.classList.add('row', 'gx-4', 'gx-lg-5', 'row-cols-1', 'row-cols-md-2', 'row-cols-xl-4', 'justify-content-center');
        section.appendChild(productRow);

        shuffleArray(categories[category]);
        categories[category].slice(0, 4).forEach(product => {
            const col = document.createElement('div');
            col.classList.add('col', 'mb-5');

            const card = document.createElement('div');
            card.classList.add('card', 'h-100');

            if (product.status !== 'vacio') {
                let color = '';
                if(product.status === 'Oferta'){
                    color = 'orange';
                } else if(product.status === 'Nuevo'){
                    color = 'green';
                } else if(product.status === 'Remate'){
                    color = 'red';
                } else if(product.status === 'Especial'){
                    color = 'purple';
                }

                const badge = document.createElement('div');
                badge.classList.add('badge', 'text-white', 'position-absolute');
                badge.style.top = '0.5rem';
                badge.style.right = '0.5rem';
                badge.textContent = product.status;
                badge.style.background = color;
                card.appendChild(badge);
            }

            const img = document.createElement('img');
            img.classList.add('card-img-top');
            img.src = product.image;
            img.alt = product.title;
            img.onclick = function() {
                showProductDetail(product);
            };
            card.appendChild(img);

            const cardBody = document.createElement('div');
            cardBody.classList.add('card-body', 'p-4');

            const textCenter = document.createElement('div');
            textCenter.classList.add('text-center');

            const title = document.createElement('h5');
            title.classList.add('fw-bolder');
            title.textContent = product.title;
            textCenter.appendChild(title);

            if (product.originalPrice) {
                const originalPrice = document.createElement('span');
                originalPrice.classList.add('text-muted', 'text-decoration-line-through');
                originalPrice.textContent = `$${product.originalPrice}`;
                textCenter.appendChild(originalPrice);
            }

            const price = document.createElement('span');
            price.textContent = formatPrice(product.price);
            textCenter.appendChild(price);

            cardBody.appendChild(textCenter);
            card.appendChild(cardBody);

            const cardFooter = document.createElement('div');
            cardFooter.classList.add('card-footer', 'p-4', 'pt-0', 'border-top-0', 'bg-transparent');

            const footerCenter = document.createElement('div');
            footerCenter.classList.add('text-center');

            const addButton = document.createElement('button');
            addButton.id = `addButton-${product.id}`;
            addButton.classList.add('btn', 'btn-outline-dark', 'mt-auto');
            addButton.innerHTML = '<i class="bi-cart-fill me-1"></i>Agregar';
            addButton.onclick = function() {
                addToCart(product.id, product.title, product.price, product.image);
            };
            footerCenter.appendChild(addButton);

            const quantityInput = document.createElement('input');
            quantityInput.type = 'number';
            quantityInput.id = `cantidad-${product.id}`;
            quantityInput.classList.add('form-control', 'mt-auto');
            quantityInput.value = 0;
            quantityInput.style.display = 'none';
            quantityInput.onchange = function() {
                updateQuantity(product.id);
                toggleButtonInput(product.id);
            };
            footerCenter.appendChild(quantityInput);

            cardFooter.appendChild(footerCenter);
            card.appendChild(cardFooter);

            col.appendChild(card);
            productRow.appendChild(col);
        });

        container.appendChild(section);
    });
}

function addToCart(productId, title, price, image) {
    console.log('Intentando agregar al carrito:', title, 'con ID:', productId);
    const quantityInput = document.getElementById('cantidad-' + productId);
    const quantity = parseInt(quantityInput.value) || 1;

    console.log('IDs de productos en el carrito antes de agregar:', carrito.map(p => p.id));
    const existingProductIndex = carrito.findIndex(p => p.id === productId);
    if (existingProductIndex !== -1) {
        console.log('Producto existente, actualizando cantidad.');
        carrito[existingProductIndex].quantity += quantity;
    } else {
        console.log('Producto nuevo, agregando al carrito.');
        carrito.push({ id: productId, title: title, price: price, quantity: quantity, image: image });
    }
    console.log('IDs de productos en el carrito después de agregar:', carrito.map(p => p.id));
    mostrarCarrito();
    toggleButtonInput(productId);
}



function updateQuantity(productId) {
    const quantityInput = document.getElementById('cantidad-' + productId);
    const quantity = parseInt(quantityInput.value);
    const productIndex = carrito.findIndex(p => p.id === productId);

    if (quantity > 0) {
        if (productIndex !== -1) {
            carrito[productIndex].quantity = quantity;
        }
    } else {
        if (productIndex !== -1) {
            carrito.splice(productIndex, 1);
        }
    }
    mostrarCarrito();
    toggleButtonInput(productId);
}

var costoEnvio = 35.00;
var minimoCompra = 400.00;

function mostrarCarrito() {
    const contenedorCarrito = document.getElementById('carritoDetalle');
    contenedorCarrito.innerHTML = ''; // Limpiar el contenido anterior del carrito

    let totalCarrito = 0;

    if(carrito.length > 0){
      carrito.forEach((producto, index) => {
          const subtotalProducto = producto.price * producto.quantity;
          totalCarrito += subtotalProducto;
          const nombreCorto = recortarTexto(producto.title, 15);

          const itemHtml = `
              <li class="dropdown-item d-flex justify-content-between align-items-center">
                  <img src="${producto.image}" class="img-fluid" style="width: 50px; height: auto;">
                  <span>${nombreCorto} - ${formatPrice(producto.price)}</span>
                  <div class="input-group">
                      <button class="btn btn-outline-secondary" type="button" onclick="cambiarCantidad(${index}, -1, event)">
                          ${producto.quantity > 1 ? '-' : '<i class="bi-trash"></i>'}
                      </button>
                      <input type="text" class="form-control text-center" value="${producto.quantity}" readonly>
                      <button class="btn btn-outline-secondary" type="button" onclick="cambiarCantidad(${index}, 1, event)">+</button>
                  </div>
                  <span class="subtotal">Subtotal: ${formatPrice(subtotalProducto)}</span>
              </li>`;
          contenedorCarrito.insertAdjacentHTML('beforeend', itemHtml);
      });
    
    // Agregar el total al final del contenedor del carrito
    const totalConEnvio = totalCarrito + costoEnvio;
    const totalHtml = `
        <li class="dropdown-item text-right">
            <strong>Subtotal: ${formatPrice(totalCarrito)}</strong>
        </li>
        <li class="dropdown-item text-right">
            <strong>Costo de Envío: ${formatPrice(costoEnvio)}</strong>
        </li>
        <li class="dropdown-item text-right">
            <strong>Total a Pagar: ${formatPrice(totalConEnvio)}</strong>
        </li>`;
    contenedorCarrito.insertAdjacentHTML('beforeend', totalHtml);

    const botonSolicitar = `
            <li class="dropdown-item text-center">
                <button class="btn btn-primary" onclick=(solicitarPedido()) type="button" ${totalCarrito < minimoCompra ? 'disabled' : ''}>Solicitar</button>
            </li>`;
        contenedorCarrito.insertAdjacentHTML('beforeend', botonSolicitar);

    } else {
        // Mostrar mensaje si el carrito está vacío
        const mensajeVacio = `
            <li class="dropdown-item text-center">
                No tienes artículos en tu carrito
            </li>`;
        contenedorCarrito.insertAdjacentHTML('beforeend', mensajeVacio);
    }

    actualizarContadorCarrito();

}

// Asegúrate de llamar a guardarCarrito() cada vez que el carrito se actualice
function cambiarCantidad(index, cambio, event) {
    event.stopPropagation();
    const producto = carrito[index];
    if (producto.quantity + cambio > 0) {
        producto.quantity += cambio;
    } else {
        carrito.splice(index, 1);
    }
    mostrarCarrito();
}

function generarFolio() {
    const fecha = new Date();
    const year = fecha.getFullYear().toString();
    const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
    const dia = fecha.getDate().toString().padStart(2, '0');
    const horas = fecha.getHours().toString().padStart(2, '0');
    const minutos = fecha.getMinutes().toString().padStart(2, '0');
    const segundos = fecha.getSeconds().toString().padStart(2, '0');
    const milisegundos = fecha.getMilliseconds().toString().padStart(3, '0');
    const numeroAleatorio = Math.floor(Math.random() * 1000).toString().padStart(3, '0');

    const folioUnico = 'SCC'+ year + mes + dia + horas + minutos + segundos + numeroAleatorio;
    
    //return year + mes + dia + horas + minutos + segundos + milisegundos + numeroAleatorio;
    return folioUnico;
}

function solicitarPedido() {
const ordenCompra = generarFolio();
    const mensajeWhatsApp = '%2AHola,+he+solicitado+el+pedido+'+ ordenCompra + '+,¿que+horarios+de+entrega+tiene+disponibles?%2A';
    const numeroTelefonico = '525524971097'; // Reemplaza con el número de teléfono correcto
    
    // Codificar el mensaje para la URL
    //const mensajeCodificado = encodeURIComponent(mensajeWhatsApp);
    
    // Construir la URL de WhatsApp
    const urlWhatsApp = 'https://api.whatsapp.com/send?phone=' + numeroTelefonico + '&text=' +mensajeWhatsApp;
    console.log(urlWhatsApp);
    // Redirigir al usuario a WhatsApp
    //window.location.href = urlWhatsApp;
    //mostrarNumeroPedido(ordenCompra);
    document.getElementById('folioPedido').textContent = ordenCompra;
    document.getElementById('enlaceWhatsApp').href = urlWhatsApp;
    document.getElementById('modalWhatsApp').style.display = 'block';
  }

  function cerrarModal() {
  document.getElementById('modalWhatsApp').style.display = 'none';
  }

function toggleButtonInput(productId) {
    const quantityInput = document.getElementById('cantidad-' + productId);
    const addButton = document.getElementById('addButton-' + productId);
    const quantity = parseInt(quantityInput.value);

    if (quantity > 0) {
        addButton.style.display = 'none';
        quantityInput.style.display = 'block';
    } else {
        addButton.style.display = 'block';
        quantityInput.style.display = 'none';
    }
}

function formatPrice(price) {
    return '$' + parseFloat(price).toFixed(2);
}

function recortarTexto(nombreCompleto, longitudMaxima) {
    return nombreCompleto.length > longitudMaxima ? nombreCompleto.slice(0, longitudMaxima) + '...' : nombreCompleto;
}

function actualizarContadorCarrito() {
    const itemCount = carrito.reduce((acumulador, producto) => acumulador + producto.quantity, 0);
    document.getElementById('cart-count').textContent = itemCount;
}
</script>

